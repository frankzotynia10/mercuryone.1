Frank Zotynia
6/4/24

******
Remember to plug in jumper for 120 0hm resistors on both MCU and toolhead board
******

** RB2209 Can Board **

$ Katapult install (Bootloader)

cd ~
git clone https://github.com/Arksine/Katapult
cd katapult
make menuconfig

Micro-controler architecture - RP2040
Flashchip - W25Q080 with CLKDIV 2
Build Katapult Deployment Appilcation - 16KiB bootloader
Com interface - Canbus
can rx - GPIO 4
can tx - GPIO 5
Can bus speed - 1000000
support bootloader entry on rapid double clkick
enable status LED - GPIO26
Q to exit, Y to save

make clean
make

-> Disconnect Can cable and connect usb.  Plug in the usb jumper on the board
-> power on and hold boot and tap reset to enter dfu mode

lsusb
-> check for Raspberry Pi RP2 Boot and grab the ID

cd ~/katapult
make flash FLASH_DEVICE=2e8a:0003

-> remove usb cable and usb jumper. plug cancable back in and power up.

$ Klipper install

cd ~/klipper
make menuconfig

[*] Enable extra low-level configuration options
Micro-controler architecture - RP2040
Bootloader offset 16KiB bootloader
Com interface - Canbus
can rx - GPIO 4
can tx - GPIO 5
Can bus speed - 1000000
Q to exit, Y to save

make clean
make

cd ~/katapult/scripts
python3 flash_can.py -i can0 -q
-> You should see RP2040 with appliation: katapult. copy canbus ID for rp2040 board
python3 flash_can.py -i can0 -f ~/klipper/out/klipper.bin -u {CANBUSIDHERE}
-> If successful, you will see application: Klipper


* M8P v2 MCU *

$ Katapult build (Bootloader)

cd ~
git clone https://github.com/Arksine/katapult.git
cd ~/katapult
make menuconfig

Micro-controller Architecture (STMicroelectronics STM32)  --->
Processor model (STM32G0B1)  --->
Build CanBoot deployment application (Do not build)  --->
Clock Reference (8 MHz crystal)  --->
Communication interface (CAN bus (on PD12/PD13))  --->
Application start offset (8KiB offset)  --->
(250000) CAN bus speed
() GPIO pins to set on bootloader entry
[*] Support bootloader entry on rapid double click of reset button
[ ] Enable bootloader entry on button (or gpio) state
[ ] Enable Status LED
Q to exit, Y to save

make clean
make

$ Klipper Build

cd ~/klipper
make menuconfig

[*] Enable extra low-level configuration options
Micro-controller Architecture (STMicroelectronics STM32) --->
Processor model (STM32G0B1) --->
Bootloader offset (8KiB bootloader) --->
Clock Reference (8 MHz crystal) --->
Communication interface (USB to CAN bus bridge (USB on PA11/PA12)) --->
CAN bus interface (CAN bus (on PD12/PD13)) --->
USB ids --->
(250000) CAN bus speed
() GPIO pins to set at micro-controller startup

make clean
make

$ Flash Katapult and Klipper

-> Power down and disconnect canbus cable
-> power on and hold boot and tap reset to enter dfu mode

lsusb
-> you will see "Bus 001 Device 008: ID 0483:df11 STMicroelectronics STM Device in DFU Mode"

sudo service klipper stop

$ Katapult
sudo dfu-util -a 0 -D ~/katapult/out/katapult.bin --dfuse-address 0x08000000:force:leave -d 0483:df11

-> press reset button

$ klipper
sudo dfu-util -a 0 -d 0483:df11 --dfuse-address 0x08002000 -D ~/klipper/out/klipper.bin

-> Press reset button

lsusb
-> You should see "Bus 001 Device 011: ID 1d50:606f OpenMoko, Inc. Geschwister Schneider CAN adapter"

sudo service klipper start

$ Can Network

sudo nano /etc/network/interfaces.d/can0

-> enter this in the can0 file
allow-hotplug can0
iface can0 can static
 bitrate 250000
 up ifconfig $IFACE txqueuelen 1024

$ printer.cfg
[mcu]
canbus_uuid: <your uuid goes here>
canbus_interface: can0
