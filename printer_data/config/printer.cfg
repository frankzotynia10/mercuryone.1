
# 6/6/26
# This file contains common pin mappings for the BIGTREETECH Manta M8P
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" "8 MHz crystal"
# and "CAN bus (on PD12/PD13)".

# See docs/Config_Reference.md for a description of parameters.

##################################
# Micro-controller configuration #
##################################
[mcu]
#   Configuration of the primary micro-controller - btt m8p v2
canbus_uuid: a87a2c3a65cc
canbus_interface: can0

[mcu nhk]
#   Nitehawk 36 USB tool head board
serial: /dev/serial/by-id/usb-Klipper_rp2040_32323232361925BE-if00
restart_method: command

[mcu rpi]
#   Configuration of the Raspberry Pi CM4 as a
#   controller for chassis fan control.
serial: /tmp/klipper_host_mcu

#################
# Include Files #
#################
[include macros.cfg]

[include leds.cfg]

[include K-ShakeTune/*.cfg]

[include AFC/*.cfg]

######################
# Kinematic settings #
######################
[printer]
#   The printer section controls high level printer settings.
kinematics: corexy
#max_velocity: 650
#max_accel: 8000
max_velocity: 500
max_accel: 6000
minimum_cruise_ratio: 0.5
#max_accel_to_decel: 3000
max_z_velocity: 12
max_z_accel: 200
square_corner_velocity: 4

[stepper_x] # M1 - A Motor
step_pin: PE6
dir_pin: PE5
enable_pin: !PC14
microsteps: 16
# GT1.5 belts with 27T pulley (pitch*teeth) - calibrated
rotation_distance: 40
# GT2 with 20T pulley
#rotation_distance: 40
# endstop homing
endstop_pin: nhk:gpio10
position_endstop: -3
position_min: -3
position_max:  279
homing_speed: 100
second_homing_speed: 3
homing_retract_dist: 5

[stepper_y] # M2 - B Motor
step_pin: PE2
dir_pin: PE1
enable_pin: !PE4
microsteps: 16
# GT1.5 belts with 27T pulley (pitch*teeth) - calibrated
rotation_distance: 40
# GT2 with 20T pulley
#rotation_distance: 40
# endstop homing
endstop_pin: ^PF3
position_endstop: 0
position_max: 260
homing_speed: 100
second_homing_speed: 3
homing_retract_dist: 5

## sensorless homing
#endstop_pin: tmc5160_stepper_y:virtual_endstop
#position_endstop: -12
#position_min: -12
#position_max: 270
#homing_speed: 20
#second_homing_speed: 3
#homing_retract_dist: 0

[stepper_z] # M3 - ZB Motor
step_pin: PB8
dir_pin: PB7
enable_pin: !PE0
# Leadscrew is Tr8x2 - 1 Start
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
#position_endstop = 0.440
position_max: 245
position_min: -5.0
homing_speed: 10
homing_retract_dist: 0

[stepper_z1] # M4 - ZL Motor
step_pin: PB4
dir_pin: PB3
enable_pin: !PB6
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16

[stepper_z2] # M5 - ZR Motor
step_pin: PG13
dir_pin: PG12
enable_pin: !PG15
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16

## Motor6
#[extruder1]
#step_pin: PG9
#dir_pin: PD7
#enable_pin: !PG11 
#heater_pin: PA1 # HE1 
#sensor_pin: PC5 # T1
#...

## Motor7
#[extruder2]
#step_pin: PD4
#dir_pin: PD3
#enable_pin: !PD6
#heater_pin: PA3 # HE2
#sensor_pin: PC4 # T2
#...

## Motor8
#[extruder3]
#step_pin: PC7
#dir_pin: PC8
#enable_pin: !PD2
#heater_pin: PA5 # HE3
#sensor_pin: PA7 # T3
#...

###########################
# Heated Bed #
###########################
[heater_bed]
heater_pin: PA0
sensor_pin: PB1 # TB 
sensor_type: Generic 3950
#control: pid
#pid_kp = 75.512
#pid_ki = 1.944
#pid_kd = 733.408
min_temp: 0
max_temp: 130

#############################
# TMC Stepper Driver Config #
#############################
[tmc5160 stepper_x]  # Motor A
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 1.5  # Adjust to your motor's rated current (max 3A IRMS, 4.2A peak)
hold_current: 0.75  # 50% of run_current to reduce heat during idle
sense_resistor: 0.075  # Verify your TMC5160 sense resistor value
stealthchop_threshold: 0  # Set to 0 to disable StealthChop for better performance
driver_TBL: 2  # Blanking time (default is 2)
driver_HEND: 6  # Hysteresis end (default is 6)
driver_HSTRT: 3  # Hysteresis start (default is 3)
interpolate: True  # Enable interpolation to 256 microsteps
# Sensorless homing
#diag1_pin: ^!PF4
#driver_SGT: -64

[tmc5160 stepper_y]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 1.5
hold_current: 0.75
sense_resistor: 0.075
stealthchop_threshold: 0
driver_TBL: 2
driver_HEND: 6
driver_HSTRT: 3
interpolate: True
# Sensorless homing
#diag1_pin: PF3
#driver_SGT: 10

[tmc2209 stepper_z] # M3 - Motor ZB
uart_pin: PB9
run_current: 0.400 # MAX 0.79
#diag_pin: PF2
stealthchop_threshold: 0

[tmc2209 stepper_z1] # M4 - Motor ZL
uart_pin: PB5
#diag_pin: PF1
run_current: 0.40 # MAX 0.79
stealthchop_threshold: 0

[tmc2209 stepper_z2] # M5 - Motor ZR
uart_pin: PG14
run_current: 0.400 # MAX 0.79
#diag_pin: PF0
stealthchop_threshold: 0

#[tmc2209 extruder1] # M6
#uart_pin: PG10
##diag_pin: PC15
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder2] # M7
#uart_pin: PD5
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder3] # M8
#uart_pin: PC6
#run_current: 0.800
#stealthchop_threshold: 999999

################
# Fans & Temps #
################
# Bento Box Fan
[fan_generic Filter_Fan]
pin: PF7

# Part Cooling Fan
[fan]
pin: nhk:gpio6
kick_start_time: .3
off_below: 0.1

# Hotend Fan
[heater_fan hotend_fan]
pin: nhk:gpio5
tachometer_pin: nhk:gpio16
tachometer_ppr: 2
max_power: 1.0
kick_start_time: .1
heater: extruder
heater_temp: 50.0
fan_speed: .6

# 2x rear noctua fans
[fan_generic Rear_Intake]
pin: PA6
tachometer_pin: PC2
max_power: 1.0
shutdown_speed: 0.20
kick_start_time: 0.5
hardware_pwm: True
cycle_time: 0.00004  # 25 kHz

# 4x front noctua fans
[fan_generic Front_Intake]
pin: PA2
tachometer_pin: PC1
max_power: 1.0
shutdown_speed: 0.20
kick_start_time: 0.5
hardware_pwm: True
cycle_time: 0.00004  # 25 kHz

# Motor Fans
[fan_generic Motor_Fans]
pin: PF9

## Fan4
#[heater_fan fan4]
#pin: PA4

## Fan5
#[temperature_fan my_temp_fan]
#pin: PA6
#tachometer_pin: PC2

## Fan6
#[heater_fan fan6]
#pin: PA2
#tachometer_pin: PC1

[temperature_sensor M8P]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor CM4]
sensor_type: temperature_host

[temperature_sensor NH36]
sensor_type: temperature_mcu
sensor_mcu: nhk
min_temp: 0
max_temp: 100

[temperature_sensor chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PB0

[temperature_sensor Stepper_Motor_A]
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC5

[temperature_sensor Stepper_Motor_B]
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC4

##################
# Probe Settings #
##################
[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_908766E55154354D38202020FF0A2A2C-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 31 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
contact_max_hotend_temperature: 180 # increase to probe at print temps
home_xy_position: 136.5, 130 # update with your safe position
home_z_hop: 5
home_z_hop_speed: 15
home_xy_move_speed: 200
home_method: proximity
home_method_when_homed: proximity
home_autocalibrate: never
#home_method: contact # use proximity for induction homing
#home_method_when_homed: proximity # after initial calibration use induction
#home_autocalibrate: unhomed # contact will calibrate beacon on first home

#[safe_z_home]
#home_xy_position: 138.5, 125
#speed: 25
#z_hop: 5
#z_hop_speed: 15
#move_to_previous: false

[bed_mesh]
algorithm: bicubic
horizontal_move_z: 5
zero_reference_position: 138.5, 125
speed: 600
## sensorless homing 
#mesh_min: 33,65
#mesh_max: 230,260
mesh_min: 25,70
mesh_max: 250,260
probe_count: 51, 51
fade_start: 1.0
fade_end: 10
fade_target: 0

[z_tilt]
z_positions:
# Mini Tanks
  # z Back
    #147, 0
    138.30, 0
  # z1 left
    #275, 250
    265.30, 254
  # z2 right
    #21, 250
    10.30, 254
points:
# 4 point z tilt
     25, 40
     250, 40
     250, 260
     20, 260
# 3 Point z tilt
#    147, 33
#    265, 250
#    35, 250
speed: 400
horizontal_move_z: 5
retry_tolerance:0.15
retries: 5

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 3
#keep_raw_csv: False
show_macros_in_webui: True
timeout: 300

#######################
# Nighthawk USB Board #
#######################
[extruder]
step_pin: nhk:gpio23
dir_pin: !nhk:gpio24
enable_pin: !nhk:gpio25
microsteps: 16
rotation_distance: 33.721
gear_ratio: 44:8, 25:17
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: nhk:gpio9
sensor_type: Generic 3950
sensor_pin: nhk:gpio29
pullup_resistor: 2200
min_temp: 0
max_temp: 315
min_extrude_temp: 170
max_extrude_only_distance: 1000                                     
max_extrude_cross_section: 30                                       

[tmc2209 extruder]
sense_resistor: 0.100
uart_pin: nhk:gpio0
tx_pin: nhk:gpio1
interpolate: false
run_current: 0.45                        #.45 minimum offers 12N of force. DO NOT EXCEED .55A as it will cause excess heat.

[adxl345]
cs_pin: nhk:gpio27
spi_software_sclk_pin: nhk:gpio18
spi_software_mosi_pin: nhk:gpio20
spi_software_miso_pin: nhk:gpio19

[resonance_tester]
accel_chip: beacon
probe_points: 138, 125, 25

[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 64.0
damping_ratio_x: 0.10

shaper_type_y: mzv
shaper_freq_y: 43.0
damping_ratio_y: 0.07

#######################
# Config File Helpers #
#######################
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE7, EXP1_2=PG1,
    EXP1_3=PG0, EXP1_4=PF15,
    EXP1_5=PF14, EXP1_6=PF13,    # Slot in the socket on this side
    EXP1_7=PF12, EXP1_8=PF11,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PE15, EXP2_4=PE11,
    EXP2_5=PE10, EXP2_6=PE14,      # Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

# See the sample-lcd.cfg file for definitions of common LCD displays.

############################
# Optional G-Code Features #
############################
[virtual_sdcard]
#   A virtual sdcard may be useful if the host machine is not fast
#   enough to run OctoPrint well. It allows the Klipper host software 
#   to directly print gcode files stored in a directory on the host 
#   using standard sdcard G-Code commands (eg, M24).
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[gcode_arcs]
resolution: 0.1

[pause_resume]

[display_status]

[respond]

[exclude_object]

#[skew_correction]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.561408428917991,
#*# 	1.8977668912977286,
#*# 	0.7946812205550039,
#*# 	0.3793555589793148,
#*# 	0.24005977334137324,
#*# 	0.2228143913948889,
#*# 	-0.05218435663654637,
#*# 	-0.20858458201684474,
#*# 	0.05677895765301889,
#*# 	0.11122116815536962
#*# model_domain = 1.868849468421087e-07,1.9383728680998846e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 69.082992
#*# model_offset = 0.00000
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 50.237
#*# pid_ki = 1.378
#*# pid_kd = 457.783
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 40.498
#*# pid_ki = 14.210
#*# pid_kd = 28.855
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.031121, -0.027285, -0.023560, -0.019880, -0.017817, -0.014741, -0.010450, -0.006786, -0.003403, 0.001506, 0.005730, 0.009439, 0.012276, 0.013324, 0.014511, 0.014139, 0.014276, 0.015452, 0.016287, 0.016406, 0.019165, 0.020640, 0.020748
#*# 	-0.034693, -0.030348, -0.028076, -0.022695, -0.020905, -0.017304, -0.012694, -0.009997, -0.006068, -0.001393, 0.003701, 0.007476, 0.010620, 0.012643, 0.013241, 0.012929, 0.013138, 0.013974, 0.014200, 0.013988, 0.017479, 0.019302, 0.019422
#*# 	-0.039398, -0.034983, -0.031270, -0.027629, -0.024985, -0.020638, -0.016297, -0.013638, -0.009895, -0.004666, -0.000215, 0.005017, 0.008610, 0.010739, 0.011389, 0.011262, 0.010742, 0.010473, 0.011040, 0.010193, 0.013108, 0.016252, 0.016400
#*# 	-0.042677, -0.038949, -0.036137, -0.032146, -0.028739, -0.024322, -0.020716, -0.015910, -0.013076, -0.006464, -0.002167, 0.003275, 0.006896, 0.009325, 0.010498, 0.009721, 0.008795, 0.008899, 0.008886, 0.009067, 0.011557, 0.014103, 0.015123
#*# 	-0.046432, -0.042934, -0.038412, -0.034517, -0.030639, -0.026483, -0.023090, -0.018094, -0.014070, -0.008704, -0.003380, 0.001772, 0.006053, 0.009089, 0.010197, 0.009361, 0.007233, 0.007687, 0.007573, 0.006899, 0.010132, 0.012076, 0.013118
#*# 	-0.047738, -0.044285, -0.040755, -0.036689, -0.032695, -0.027936, -0.024289, -0.020101, -0.015493, -0.008711, -0.003283, 0.003011, 0.005954, 0.008498, 0.010182, 0.009421, 0.007229, 0.007962, 0.006510, 0.005635, 0.010698, 0.010764, 0.012609
#*# 	-0.050356, -0.046262, -0.042424, -0.038840, -0.035481, -0.029620, -0.025138, -0.020981, -0.015758, -0.009372, -0.004039, 0.002653, 0.005748, 0.009112, 0.010419, 0.008480, 0.007316, 0.006519, 0.006564, 0.006154, 0.008730, 0.010352, 0.011566
#*# 	-0.053141, -0.049077, -0.045260, -0.040676, -0.036974, -0.031997, -0.027924, -0.022201, -0.017716, -0.011080, -0.004587, 0.002284, 0.006120, 0.008734, 0.009610, 0.008374, 0.006505, 0.006236, 0.006389, 0.005587, 0.008273, 0.009149, 0.010801
#*# 	-0.055728, -0.051453, -0.047147, -0.042589, -0.038789, -0.033875, -0.029326, -0.024160, -0.019262, -0.012844, -0.005621, 0.000037, 0.004593, 0.007832, 0.008535, 0.007578, 0.004716, 0.004283, 0.002762, 0.002762, 0.004855, 0.006541, 0.009471
#*# 	-0.058900, -0.054183, -0.052195, -0.046623, -0.042163, -0.036617, -0.031932, -0.026252, -0.021247, -0.014855, -0.007212, -0.000925, 0.003113, 0.006939, 0.007418, 0.006014, 0.003625, 0.001709, 0.000032, 0.000406, 0.002368, 0.005086, 0.009240
#*# 	-0.060755, -0.057236, -0.051837, -0.047139, -0.042969, -0.038201, -0.033145, -0.028257, -0.023168, -0.015880, -0.008467, -0.001635, 0.002394, 0.005667, 0.006155, 0.005772, 0.002648, 0.000584, -0.000258, -0.001301, 0.000784, 0.004443, 0.008467
#*# 	-0.059942, -0.056275, -0.053406, -0.048802, -0.044174, -0.039157, -0.033534, -0.028958, -0.023765, -0.017544, -0.010410, -0.004005, 0.000628, 0.005113, 0.004994, 0.004359, 0.000770, 0.000551, 0.000087, -0.001485, 0.001817, 0.006272, 0.008420
#*# 	-0.062454, -0.058058, -0.053983, -0.048241, -0.044360, -0.038952, -0.033867, -0.028838, -0.023825, -0.018188, -0.010001, -0.004092, 0.000394, 0.004380, 0.004802, 0.004281, 0.002337, 0.000671, 0.001358, 0.000505, 0.003657, 0.006057, 0.008523
#*# 	-0.064496, -0.058161, -0.053018, -0.049511, -0.044146, -0.039172, -0.033573, -0.028982, -0.024171, -0.018254, -0.011553, -0.005191, 0.000805, 0.003843, 0.005239, 0.004621, 0.003438, 0.001933, 0.002083, 0.001281, 0.004184, 0.006181, 0.008320
#*# 	-0.062390, -0.057556, -0.053934, -0.048383, -0.043879, -0.039329, -0.033472, -0.028588, -0.024188, -0.016905, -0.010637, -0.004093, 0.000671, 0.004147, 0.004893, 0.005733, 0.003309, 0.003012, 0.002508, 0.002935, 0.004166, 0.007297, 0.008910
#*# 	-0.062749, -0.057310, -0.054273, -0.049283, -0.043523, -0.039361, -0.033145, -0.028758, -0.023778, -0.017169, -0.010826, -0.003890, 0.001348, 0.004811, 0.006150, 0.006509, 0.005180, 0.004813, 0.004078, 0.004555, 0.006561, 0.007989, 0.009708
#*# 	-0.063557, -0.057891, -0.052950, -0.047858, -0.043668, -0.038010, -0.032347, -0.028927, -0.023448, -0.016915, -0.010347, -0.003661, 0.001677, 0.005285, 0.006381, 0.006905, 0.004874, 0.005757, 0.004023, 0.004164, 0.005592, 0.007858, 0.008955
#*# 	-0.062360, -0.057255, -0.052672, -0.048082, -0.043083, -0.038349, -0.033498, -0.028246, -0.024338, -0.017472, -0.010554, -0.004144, 0.002489, 0.004720, 0.007239, 0.007253, 0.005674, 0.004727, 0.004007, 0.004339, 0.005858, 0.006967, 0.008711
#*# 	-0.061772, -0.056377, -0.051453, -0.046884, -0.042458, -0.036767, -0.032497, -0.028229, -0.024435, -0.016858, -0.009668, -0.003914, 0.003047, 0.005881, 0.007989, 0.007450, 0.006479, 0.006540, 0.004648, 0.005001, 0.006283, 0.007609, 0.008617
#*# 	-0.060351, -0.055112, -0.051677, -0.047433, -0.041855, -0.036858, -0.033155, -0.028891, -0.023174, -0.017322, -0.009712, -0.002411, 0.003488, 0.006946, 0.008329, 0.008035, 0.006293, 0.006093, 0.005183, 0.005560, 0.006361, 0.007423, 0.008770
#*# 	-0.059569, -0.055993, -0.050490, -0.047487, -0.041816, -0.036974, -0.033615, -0.028968, -0.023487, -0.016879, -0.010548, -0.002191, 0.003844, 0.007457, 0.008531, 0.008932, 0.007329, 0.007817, 0.006247, 0.006782, 0.007505, 0.008603, 0.008622
#*# 	-0.059745, -0.054267, -0.050389, -0.046885, -0.041654, -0.036755, -0.034057, -0.029421, -0.024409, -0.018128, -0.011357, -0.003459, 0.003126, 0.007617, 0.008524, 0.009846, 0.008843, 0.008584, 0.006744, 0.007098, 0.008127, 0.009279, 0.008857
#*# 	-0.057560, -0.053445, -0.049044, -0.045816, -0.042118, -0.036559, -0.033658, -0.029159, -0.024547, -0.017172, -0.010475, -0.002982, 0.004032, 0.007650, 0.010065, 0.011060, 0.009918, 0.009897, 0.008630, 0.008255, 0.009407, 0.010483, 0.010277
#*# 	-0.055847, -0.052407, -0.048577, -0.045949, -0.042567, -0.036796, -0.034565, -0.030612, -0.024706, -0.018007, -0.011240, -0.003082, 0.002830, 0.007983, 0.010052, 0.011307, 0.010767, 0.010509, 0.009975, 0.008567, 0.010060, 0.009974, 0.010606
#*# 	-0.054557, -0.050692, -0.047382, -0.045007, -0.041751, -0.036584, -0.033989, -0.030159, -0.025950, -0.018808, -0.011843, -0.003220, 0.002651, 0.008095, 0.011572, 0.013668, 0.011862, 0.012020, 0.010808, 0.010567, 0.010538, 0.010872, 0.010499
#*# 	-0.053100, -0.049288, -0.046236, -0.043623, -0.041361, -0.036077, -0.033312, -0.028720, -0.025461, -0.018642, -0.011049, -0.002994, 0.004819, 0.009626, 0.012758, 0.014652, 0.013554, 0.012879, 0.012506, 0.011447, 0.011372, 0.012016, 0.011937
#*# 	-0.053016, -0.049207, -0.046268, -0.043768, -0.040778, -0.035540, -0.032909, -0.029267, -0.023494, -0.017195, -0.009349, -0.001723, 0.006192, 0.009629, 0.013182, 0.014794, 0.013738, 0.013918, 0.012924, 0.011602, 0.011854, 0.012029, 0.011577
#*# 	-0.053130, -0.048451, -0.044748, -0.043706, -0.040487, -0.034739, -0.032212, -0.027551, -0.024039, -0.016878, -0.010240, -0.002737, 0.006476, 0.009988, 0.013753, 0.015690, 0.015137, 0.015136, 0.014011, 0.013425, 0.013568, 0.012896, 0.012697
#*# x_count = 23
#*# y_count = 28
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 83.2462
#*# max_x = 186.754
#*# min_y = 78.2462
#*# max_y = 181.754
#*#
#*# [skew_correction my_skew_profile]
#*# xy_skew = 0.004699639108401633
#*# xz_skew = 0.0
#*# yz_skew = 0.0
