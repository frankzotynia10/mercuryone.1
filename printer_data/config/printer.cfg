
# 6/6/26
# This file contains common pin mappings for the BIGTREETECH Manta M8P
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" "8 MHz crystal"
# and "CAN bus (on PD12/PD13)".

# See docs/Config_Reference.md for a description of parameters.

##################################
# Micro-controller configuration #
##################################
[mcu]
#   Configuration of the primary micro-controller - btt m8p v2
canbus_uuid: a87a2c3a65cc
canbus_interface: can0

[mcu nhk]
#   Nitehawk 36 USB tool head board
serial: /dev/serial/by-id/usb-Klipper_rp2040_32323232361925BE-if00
restart_method: command

[mcu rpi]
#   Configuration of the Raspberry Pi CM4 as a
#   controller for chassis fan control.
serial: /tmp/klipper_host_mcu

#################
# Include Files #
#################
[include macros.cfg]

[include leds.cfg]

[include K-ShakeTune/*.cfg]

#[include mmu/base/*.cfg]
#include mmu/optional/client_macros.cfg]

######################
# Kinematic settings #
######################
[printer]
#   The printer section controls high level printer settings.
kinematics: corexy
#max_velocity: 650
#max_accel: 8000
max_velocity: 500
max_accel: 10000
minimum_cruise_ratio: 0.5
#max_accel_to_decel: 3000
max_z_velocity: 12
max_z_accel: 200
square_corner_velocity: 4

[stepper_x] # M1 - A Motor
step_pin: PE6
dir_pin: PE5
enable_pin: !PC14
microsteps: 16
rotation_distance: 40
# endstop homing
endstop_pin: nhk:gpio10
position_endstop: -3
position_min: -3
position_max:  273
homing_speed: 100
second_homing_speed: 3
homing_retract_dist: 5

[stepper_y] # M2 - B Motor
step_pin: PE2
dir_pin: PE1
enable_pin: !PE4
microsteps: 16
rotation_distance: 40
# endstop homing
endstop_pin: ^PF3
position_endstop: 0
position_max: 260
homing_speed: 100
second_homing_speed: 3
homing_retract_dist: 5

## sensorless homing
#endstop_pin: tmc5160_stepper_y:virtual_endstop
#position_endstop: -12
#position_min: -12
#position_max: 270
#homing_speed: 20
#second_homing_speed: 3
#homing_retract_dist: 0

[stepper_z] # M3 - ZB Motor
step_pin: PB8
dir_pin: PB7
enable_pin: !PE0
# Leadscrew is Tr8x2 - 1 Start
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
#position_endstop = 0.440
position_max: 245
position_min: -5.0
homing_speed: 10
homing_retract_dist: 0

[stepper_z1] # M4 - ZL Motor
step_pin: PB4
dir_pin: PB3
enable_pin: !PB6
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16

[stepper_z2] # M5 - ZR Motor
step_pin: PG13
dir_pin: PG12
enable_pin: !PG15
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16

## Motor6
#[extruder1]
#step_pin: PG9
#dir_pin: PD7
#enable_pin: !PG11 
#heater_pin: PA1 # HE1 
#sensor_pin: PC5 # T1
#...

## Motor7
#[extruder2]
#step_pin: PD4
#dir_pin: PD3
#enable_pin: !PD6
#heater_pin: PA3 # HE2
#sensor_pin: PC4 # T2
#...

## Motor8
#[extruder3]
#step_pin: PC7
#dir_pin: PC8
#enable_pin: !PD2
#heater_pin: PA5 # HE3
#sensor_pin: PA7 # T3
#...

###########################
# Heated Bed #
###########################
[heater_bed]
heater_pin: PA0
sensor_pin: PB1 # TB 
sensor_type: Generic 3950
#control: pid
#pid_kp = 75.512
#pid_ki = 1.944
#pid_kd = 733.408
min_temp: 0
max_temp: 130

#############################
# TMC Stepper Driver Config #
#############################
[tmc5160 stepper_x]  # Motor A
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 1.5  # Adjust to your motor's rated current (max 3A IRMS, 4.2A peak)
hold_current: 0.75  # 50% of run_current to reduce heat during idle
sense_resistor: 0.075  # Verify your TMC5160 sense resistor value
stealthchop_threshold: 0  # Set to 0 to disable StealthChop for better performance
driver_TBL: 2  # Blanking time (default is 2)
driver_HEND: 6  # Hysteresis end (default is 6)
driver_HSTRT: 3  # Hysteresis start (default is 3)
interpolate: True  # Enable interpolation to 256 microsteps
# Sensorless homing
#diag1_pin: ^!PF4
#driver_SGT: -64

[tmc5160 stepper_y]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 1.5
hold_current: 0.75
sense_resistor: 0.075
stealthchop_threshold: 0
driver_TBL: 2
driver_HEND: 6
driver_HSTRT: 3
interpolate: True
# Sensorless homing
#diag1_pin: PF3
#driver_SGT: 10

[tmc2209 stepper_z] # M3 - Motor ZB
uart_pin: PB9
run_current: 0.400 # MAX 0.79
#diag_pin: PF2
stealthchop_threshold: 0

[tmc2209 stepper_z1] # M4 - Motor ZL
uart_pin: PB5
#diag_pin: PF1
run_current: 0.40 # MAX 0.79
stealthchop_threshold: 0

[tmc2209 stepper_z2] # M5 - Motor ZR
uart_pin: PG14
run_current: 0.400 # MAX 0.79
#diag_pin: PF0
stealthchop_threshold: 0

#[tmc2209 extruder1] # M6
#uart_pin: PG10
##diag_pin: PC15
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder2] # M7
#uart_pin: PD5
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder3] # M8
#uart_pin: PC6
#run_current: 0.800
#stealthchop_threshold: 999999

################
# Fans & Temps #
################
# Bento Box Fan
[fan_generic Filter_Fan]
pin: PF7

# Part Cooling Fan
[fan]
pin: nhk:gpio6

# Hotend Fan
[heater_fan hotend_fan]
pin: nhk:gpio5
tachometer_pin: nhk:gpio16
tachometer_ppr: 2

# 2x rear noctua fans
[fan_generic Rear_Intake]
pin: PA6
tachometer_pin: PC2
max_power: 1.0
shutdown_speed: 0.20
kick_start_time: 0.5
hardware_pwm: True
cycle_time: 0.00004  # 25 kHz

# 4x front noctua fans
[fan_generic Front_Intake]
pin: PA2
tachometer_pin: PC1
max_power: 1.0
shutdown_speed: 0.20
kick_start_time: 0.5
hardware_pwm: True
cycle_time: 0.00004  # 25 kHz

# Motor Fans
[fan_generic Motor_Fans]
pin: PF9

## Fan4
#[heater_fan fan4]
#pin: PA4

## Fan5
#[temperature_fan my_temp_fan]
#pin: PA6
#tachometer_pin: PC2

## Fan6
#[heater_fan fan6]
#pin: PA2
#tachometer_pin: PC1

[temperature_sensor M8P]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor CM4]
sensor_type: temperature_host

[temperature_sensor NH36]
sensor_type: temperature_mcu
sensor_mcu: nhk
min_temp: 0
max_temp: 100

[temperature_sensor chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PB0

[temperature_sensor Stepper_Motor_A]
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC5

[temperature_sensor Stepper_Motor_B]
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC4

##################
# Probe Settings #
##################
[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_908766E55154354D38202020FF0A2A2C-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 31 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
contact_max_hotend_temperature: 180 # increase to probe at print temps
home_xy_position: 136.5, 130 # update with your safe position
home_z_hop: 5
home_z_hop_speed: 15
home_xy_move_speed: 200
home_method: proximity
home_method_when_homed: proximity
home_autocalibrate: never
#home_method: contact # use proximity for induction homing
#home_method_when_homed: proximity # after initial calibration use induction
#home_autocalibrate: unhomed # contact will calibrate beacon on first home

#[safe_z_home]
#home_xy_position: 138.5, 125
#speed: 25
#z_hop: 5
#z_hop_speed: 15
#move_to_previous: false

[bed_mesh]
algorithm: bicubic
horizontal_move_z: 5
zero_reference_position: 138.5, 125
speed: 600
## sensorless homing 
#mesh_min: 33,65
#mesh_max: 230,260
mesh_min: 25,70
mesh_max: 250,260
probe_count: 51, 51
fade_start: 1.0
fade_end: 10
fade_target: 0

[z_tilt]
z_positions:
# Mini Tanks
  # z Back
    #147, 0
    138.30, 0
  # z1 left
    #275, 250
    265.30, 254
  # z2 right
    #21, 250
    10.30, 254
points:
# 4 point z tilt
     25, 40
     250, 40
     250, 260
     20, 260
# 3 Point z tilt
#    147, 33
#    265, 250
#    35, 250
speed: 400
horizontal_move_z: 5
retry_tolerance:0.15
retries: 5

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 3
#keep_raw_csv: False
show_macros_in_webui: True
timeout: 300

#######################
# Nighthawk USB Board #
#######################
[extruder]
step_pin: nhk:gpio23
dir_pin: !nhk:gpio24
enable_pin: !nhk:gpio25
microsteps: 16
rotation_distance: 31.18												
gear_ratio: 44:8, 25:17
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: nhk:gpio9
sensor_type: Generic 3950
sensor_pin: nhk:gpio29
pullup_resistor: 2200
min_temp: 0
max_temp: 315
#min_extrude_temp: 170
min_extrude_temp: 0
max_extrude_only_distance: 1000                                     
max_extrude_cross_section: 30                                       

[tmc2209 extruder]
sense_resistor: 0.100
uart_pin: nhk:gpio0
tx_pin: nhk:gpio1
interpolate: false
run_current: 0.45                        #.45 minimum offers 12N of force. DO NOT EXCEED .55A as it will cause excess heat.

[adxl345]
cs_pin: nhk:gpio27
spi_software_sclk_pin: nhk:gpio18
spi_software_mosi_pin: nhk:gpio20
spi_software_miso_pin: nhk:gpio19

[resonance_tester]
accel_chip: adxl345
accel_per_hz: 100
sweeping_accel: 400
sweeping_period: 0

accel_chip: beacon
probe_points: 138, 125, 25

#######################
# Config File Helpers #
#######################
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE7, EXP1_2=PG1,
    EXP1_3=PG0, EXP1_4=PF15,
    EXP1_5=PF14, EXP1_6=PF13,    # Slot in the socket on this side
    EXP1_7=PF12, EXP1_8=PF11,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PE15, EXP2_4=PE11,
    EXP2_5=PE10, EXP2_6=PE14,      # Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

# See the sample-lcd.cfg file for definitions of common LCD displays.

############################
# Optional G-Code Features #
############################
[virtual_sdcard]
#   A virtual sdcard may be useful if the host machine is not fast
#   enough to run OctoPrint well. It allows the Klipper host software 
#   to directly print gcode files stored in a directory on the host 
#   using standard sdcard G-Code commands (eg, M24).
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[gcode_arcs]
resolution: 0.1

[pause_resume]

[display_status]

[respond]

[exclude_object]

[skew_correction]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.5373436473321205,
#*# 	1.857505980364045,
#*# 	0.7563704042823886,
#*# 	0.37485164330808735,
#*# 	0.3814137775884141,
#*# 	0.37894947955458363,
#*# 	-0.1961714572619801,
#*# 	-0.41705082654425424,
#*# 	0.1237342104788977,
#*# 	0.210595160050881
#*# model_domain = 1.8583294596938657e-07,1.9360304551893682e-07
#*# model_range = 0.200208,5.000208
#*# model_temp = 59.729575
#*# model_offset = 0.00000
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 50.237
#*# pid_ki = 1.378
#*# pid_kd = 457.783
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 40.498
#*# pid_ki = 14.210
#*# pid_kd = 28.855
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.029001, -0.022961, -0.019449, -0.016189, -0.014432, -0.010348, -0.011589, -0.006448, -0.002565, -0.002789, 0.000430, 0.005441, 0.008382, 0.011150, 0.014128, 0.013987, 0.013910, 0.011090, 0.008414, 0.005147, 0.003081, 0.000948, 0.000142, 0.001956
#*# 	-0.031545, -0.025729, -0.022999, -0.019991, -0.017299, -0.013621, -0.014879, -0.011820, -0.007373, -0.004827, -0.001969, 0.002022, 0.004811, 0.010067, 0.010799, 0.012086, 0.012260, 0.006297, 0.005795, 0.003027, -0.000284, -0.000561, 0.000728, 0.000589
#*# 	-0.032241, -0.027742, -0.025325, -0.022709, -0.020247, -0.017416, -0.017598, -0.013136, -0.010310, -0.007086, -0.003059, 0.000640, 0.003927, 0.008312, 0.009715, 0.011795, 0.012640, 0.009947, 0.006871, 0.003858, -0.000692, -0.002343, -0.001064, -0.000481
#*# 	-0.035009, -0.031206, -0.028440, -0.025234, -0.024506, -0.019452, -0.018777, -0.014756, -0.011090, -0.008196, -0.006827, -0.001603, 0.004373, 0.006736, 0.011366, 0.013768, 0.012693, 0.009144, 0.006925, 0.002733, 0.000908, -0.000062, -0.001422, -0.001721
#*# 	-0.037331, -0.033542, -0.029745, -0.028954, -0.024783, -0.022044, -0.019575, -0.017162, -0.013532, -0.011359, -0.008385, -0.004342, 0.001216, 0.005173, 0.009701, 0.012054, 0.014593, 0.010081, 0.007668, 0.005387, 0.000492, -0.001534, -0.003150, -0.003215
#*# 	-0.040273, -0.037299, -0.034939, -0.032247, -0.028915, -0.024775, -0.021875, -0.018421, -0.017408, -0.013036, -0.010455, -0.003562, -0.001028, 0.003011, 0.006933, 0.010619, 0.012268, 0.010265, 0.004582, 0.002939, 0.000384, -0.003372, -0.004023, -0.002207
#*# 	-0.043917, -0.039060, -0.036950, -0.034168, -0.029496, -0.027166, -0.022895, -0.021350, -0.018272, -0.015339, -0.013163, -0.008498, -0.003959, 0.002856, 0.008739, 0.010210, 0.010743, 0.009077, 0.003564, 0.001789, 0.001684, -0.005037, -0.003429, -0.002994
#*# 	-0.045702, -0.041787, -0.038812, -0.035539, -0.031435, -0.028479, -0.025023, -0.023603, -0.020379, -0.017244, -0.012434, -0.010005, -0.004499, 0.001670, 0.006929, 0.009597, 0.009823, 0.009585, 0.005576, 0.000950, -0.001634, -0.001955, -0.002851, -0.001148
#*# 	-0.047649, -0.042620, -0.039076, -0.035435, -0.032949, -0.030295, -0.027170, -0.021765, -0.018600, -0.017363, -0.013479, -0.007767, -0.002458, 0.002614, 0.005355, 0.007418, 0.009568, 0.007392, 0.005223, 0.003221, 0.000718, -0.000622, -0.001418, 0.000775
#*# 	-0.048103, -0.044753, -0.040035, -0.036675, -0.032647, -0.027213, -0.026880, -0.022088, -0.017695, -0.015512, -0.012519, -0.008301, -0.001461, 0.003690, 0.008408, 0.012373, 0.009425, 0.009971, 0.007864, 0.003279, 0.002833, 0.001020, 0.001469, 0.002745
#*# 	-0.046733, -0.044189, -0.039721, -0.037801, -0.033220, -0.031226, -0.025688, -0.021527, -0.018632, -0.016346, -0.010680, -0.004785, -0.002117, 0.003331, 0.007301, 0.011007, 0.012138, 0.012099, 0.008023, 0.005844, 0.003380, 0.002991, 0.002640, 0.004203
#*# 	-0.046260, -0.042413, -0.039953, -0.036714, -0.032563, -0.030818, -0.025635, -0.021823, -0.017300, -0.013340, -0.011924, -0.007258, -0.000809, 0.003905, 0.010105, 0.012026, 0.012895, 0.009094, 0.010099, 0.007390, 0.005823, 0.003727, 0.004525, 0.007498
#*# 	-0.047298, -0.042231, -0.040632, -0.037957, -0.032004, -0.030486, -0.027063, -0.022153, -0.016506, -0.014050, -0.011339, -0.007172, -0.000319, 0.003867, 0.010261, 0.012153, 0.015324, 0.011292, 0.010469, 0.006531, 0.004879, 0.002521, 0.003113, 0.007039
#*# 	-0.045897, -0.043636, -0.041507, -0.036259, -0.033468, -0.028369, -0.024991, -0.020478, -0.017806, -0.013821, -0.011384, -0.006129, 0.000084, 0.005990, 0.010868, 0.013806, 0.014788, 0.012566, 0.011396, 0.010013, 0.006000, 0.005865, 0.006144, 0.007979
#*# 	-0.044778, -0.039920, -0.039130, -0.034782, -0.030210, -0.027516, -0.022851, -0.020298, -0.017018, -0.011726, -0.010440, -0.005531, 0.000198, 0.008029, 0.013764, 0.016047, 0.017394, 0.016004, 0.013646, 0.010999, 0.006476, 0.006415, 0.007091, 0.010391
#*# 	-0.045338, -0.040727, -0.038254, -0.033507, -0.031254, -0.027922, -0.023678, -0.018762, -0.016671, -0.014732, -0.009597, -0.005248, 0.001373, 0.008315, 0.015280, 0.018838, 0.019452, 0.016048, 0.014163, 0.011303, 0.010173, 0.008065, 0.008124, 0.009841
#*# 	-0.044739, -0.039850, -0.038073, -0.034316, -0.029487, -0.026985, -0.020424, -0.018792, -0.015729, -0.015757, -0.010522, -0.007208, 0.001372, 0.010226, 0.014342, 0.018686, 0.017419, 0.017293, 0.015635, 0.012624, 0.009783, 0.010912, 0.010057, 0.010105
#*# 	-0.045256, -0.041386, -0.038840, -0.033846, -0.030059, -0.027529, -0.021686, -0.019162, -0.016875, -0.014509, -0.010425, -0.004728, 0.001701, 0.009246, 0.016146, 0.018898, 0.021961, 0.021257, 0.018363, 0.015727, 0.013374, 0.012494, 0.011433, 0.012250
#*# 	-0.042804, -0.040266, -0.036856, -0.031201, -0.027964, -0.025693, -0.019270, -0.016008, -0.016491, -0.011704, -0.009803, -0.004496, 0.004679, 0.011912, 0.018271, 0.023756, 0.022434, 0.024552, 0.021245, 0.019746, 0.016066, 0.014796, 0.014196, 0.014267
#*# 	-0.044028, -0.039037, -0.036167, -0.031756, -0.028136, -0.024157, -0.021198, -0.014294, -0.015106, -0.011468, -0.009303, -0.002378, 0.003460, 0.012872, 0.019783, 0.023440, 0.025753, 0.024938, 0.023343, 0.021944, 0.019057, 0.017720, 0.016903, 0.016983
#*# 	-0.042019, -0.037863, -0.033243, -0.031397, -0.026473, -0.023681, -0.020781, -0.015414, -0.013756, -0.011115, -0.006402, -0.000421, 0.006536, 0.014537, 0.018819, 0.024888, 0.026684, 0.026337, 0.025620, 0.023573, 0.021144, 0.019968, 0.019263, 0.018553
#*# 	-0.040369, -0.036225, -0.032745, -0.030681, -0.025857, -0.022449, -0.019086, -0.014977, -0.012363, -0.010836, -0.006260, -0.001586, 0.003787, 0.012885, 0.020716, 0.024576, 0.029329, 0.030985, 0.028813, 0.027252, 0.022360, 0.022977, 0.021901, 0.020697
#*# 	-0.039148, -0.035517, -0.030122, -0.027995, -0.024371, -0.022015, -0.018819, -0.014559, -0.013413, -0.010612, -0.006845, -0.000900, 0.005815, 0.011478, 0.022203, 0.026353, 0.029703, 0.033636, 0.031975, 0.030233, 0.028162, 0.025790, 0.023685, 0.023231
#*# x_count = 24
#*# y_count = 23
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 79.9776
#*# max_x = 187.407
#*# min_y = 87.3626
#*# max_y = 172.89
#*#
#*# [skew_correction my_skew_profile]
#*# xy_skew = -0.0014549011336352409
#*# xz_skew = 0.0
#*# yz_skew = 0.0
