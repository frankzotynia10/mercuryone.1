# 6/6/26
# This file contains common pin mappings for the BIGTREETECH Manta M8P
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" "8 MHz crystal"
# and "CAN bus (on PD12/PD13)".

# See docs/Config_Reference.md for a description of parameters.

##################################
# Micro-controller configuration #
##################################
[mcu]
#   Configuration of the primary micro-controller.
canbus_uuid: a87a2c3a65cc
canbus_interface: can0

[mcu EBBCan]
#    Tool head canbus board
canbus_uuid: 20eb10e3f813
canbus_interface: can0

[mcu rpi]
#   Configuration of the Raspberry Pi CM4 as a
#   controller for chassis fan control.
serial: /tmp/klipper_host_mcu

#################
# Include Files #
#################
[include macros.cfg]
[include leds.cfg]
[include K-ShakeTune/*.cfg]

######################
# Kinematic settings #
######################
[printer]
#   The printer section controls high level printer settings.
kinematics: corexy
max_velocity: 600
max_accel: 3000
minimum_cruise_ratio: 0.5
#max_accel_to_decel: 1000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5

[stepper_x] # M1 - A Motor
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 16
rotation_distance: 40
#endstop_pin: ^PF4
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: 0
position_min: 0
position_max: 280
homing_speed: 20
#second_homing_speed: 3
homing_retract_dist: 0

[stepper_y] # M2 - B Motor
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 16
rotation_distance: 40
endstop_pin: ^PF3
position_endstop: 0
position_max: 250
homing_speed: 20
#second_homing_speed: 3
homing_retract_dist: 0

[stepper_z] # M3 - ZB Motor
step_pin: PB8
dir_pin: PB7
enable_pin: !PE0
# Leadscrew is Tr8x2 - 1 Start
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
#position_endstop = 0.440
position_max: 300
position_min: -5.0
homing_speed: 10
homing_retract_dist: 0

[stepper_z1] # M4 - ZL Motor
step_pin: PB4
dir_pin: PB3
enable_pin: !PB6
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16

[stepper_z2] # M5 - ZR Motor
step_pin: PG13
dir_pin: PG12
enable_pin: !PG15
rotation_distance: 2
full_steps_per_rotation: 200
microsteps: 16

## Motor6
#[extruder1]
#step_pin: PG9
#dir_pin: PD7
#enable_pin: !PG11 
#heater_pin: PA1 # HE1 
#sensor_pin: PC5 # T1
#...

## Motor7
#[extruder2]
#step_pin: PD4
#dir_pin: PD3
#enable_pin: !PD6
#heater_pin: PA3 # HE2
#sensor_pin: PC4 # T2
#...

## Motor8
#[extruder3]
#step_pin: PC7
#dir_pin: PC8
#enable_pin: !PD2
#heater_pin: PA5 # HE3
#sensor_pin: PA7 # T3
#...

###########################
# Heated Bed #
###########################
[heater_bed]
heater_pin: PA0
sensor_pin: PB1 # TB 
sensor_type: Generic 3950
control: pid
pid_kp = 75.512
pid_ki = 1.944
pid_kd = 733.408
min_temp: 0
max_temp: 130

#############################
# TMC Stepper Driver Config #
#############################
[tmc2209 stepper_x] # M1 - Motor A
uart_pin: PC13
diag_pin: PF4 
run_current: 0.800
stealthchop_threshold: 0
driver_SGTHRS: 50
# Highest Value is 255.  This is the most sensitive.
# 0 is least sensitive.

[tmc2209 stepper_y] # M2 - Motor B
uart_pin: PE3
#diag_pin: PF3
run_current: 0.800
stealthchop_threshold: 0
# driver_SGTHRS: 70
# Highest Value is 255.  This is the most sensitive.
# 0 is least sensitive.

[tmc2209 stepper_z] # M3 - Motor ZB
uart_pin: PB9
run_current: 0.700
#diag_pin: PF2
stealthchop_threshold: 0

[tmc2209 stepper_z1] # M4 - Motor ZL
uart_pin: PB5
#diag_pin: PF1
run_current: 0.700
stealthchop_threshold: 0

[tmc2209 stepper_z2] # M5 - Motor ZR
uart_pin: PG14
run_current: 0.700
#diag_pin: PF0
stealthchop_threshold: 0

#[tmc2209 extruder1] # M6
#uart_pin: PG10
##diag_pin: PC15
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder2] # M7
#uart_pin: PD5
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder3] # M8
#uart_pin: PC6
#run_current: 0.800
#stealthchop_threshold: 999999

################
# Fans & Temps #
################
[fan_generic Filter_Fan]
pin: PA4

# Part Cooling Fan
[fan]
pin: EBBCan:gpio13

[heater_fan hotend_fan]
pin: EBBCan:gpio14
heater: extruder
heater_temp: 50.0

[controller_fan Left_Intake]
pin: PA6
tachometer_pin: PC2
stepper: stepper_x, stepper_y, stepper_z, stepper_z1, stepper_z2
max_power: 1.0
shutdown_speed: 0.0  # Ensure the fan turns off properly
kick_start_time: 0.5
hardware_pwm: True
cycle_time: 0.00004  # 25 kHz

[controller_fan Right_Intake]
pin: PA2
tachometer_pin: PC1
stepper: stepper_x, stepper_y, stepper_z, stepper_z1, stepper_z2
max_power: 1.0
shutdown_speed: 0.0  # Ensure the fan turns off properly
kick_start_time: 0.5
hardware_pwm: True
cycle_time: 0.00004  # 25 kHz

#[fan_generic 4W_FAN0]
#pin: EBBCan:gpio15
#tachometer_pin: EBBCan:gpio12
#tachometer_ppr: 1

## Fan3
#[heater_fan fan3]
#pin: PF8

## Fan4
#[heater_fan fan4]
#pin: PA4

## Fan5
#[temperature_fan my_temp_fan]
#pin: PA6
#tachometer_pin: PC2

## Fan6
#[heater_fan fan6]
#pin: PA2
#tachometer_pin: PC1

[temperature_sensor M8P]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor CM4]
sensor_type: temperature_host

[temperature_sensor RB2209]
sensor_type: Generic 3950
sensor_pin: EBBCan:gpio28

[temperature_sensor chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PB0

##################
# Probe Settings #
##################
[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_908766E55154354D38202020FF0A2A2C-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 31 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2

[safe_z_home]
home_xy_position: 138.5, 125
speed: 25
z_hop: 5
z_hop_speed: 15
#move_to_previous: false

[bed_mesh]
algorithm: bicubic
horizontal_move_z: 5
zero_reference_position: 138.5, 125
speed: 600
mesh_min: 33,65
mesh_max: 255,260
probe_count: 51, 51
fade_start: 1.0
fade_end: 10
fade_target: 0

[z_tilt]
z_positions:
# Mini Tanks
  # z Back
    147, 0
  # z1 left
    275, 250
  # z2 right
    21, 250
points:
# 4 point z tilt
     40, 40
     260, 40
     260, 250
     35, 250
# 3 Point z tilt
#    147, 33
#    265, 250
#    35, 250
speed: 400
horizontal_move_z: 5
retry_tolerance:0.150
retries: 5

####################
# RP2209 Can Board #
####################
[adxl345]
cs_pin: EBBCan:gpio1
spi_software_sclk_pin: EBBCan:gpio2
spi_software_mosi_pin: EBBCan:gpio0
spi_software_miso_pin: EBBCan:gpio3
axes_map: z,-y,x

[resonance_tester]
accel_chip: beacon
probe_points: 137, 125, 20

#[resonance_tester]
#probe_points: 137, 125, 20
#accel_chip: adxl345

[extruder]
step_pin: EBBCan:gpio18
dir_pin: !EBBCan:gpio19
enable_pin: !EBBCan:gpio17
microsteps: 16
gear_ratio: 50:17 
rotation_distance: 33.500
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan:gpio7
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: EBBCan:gpio27
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 300

# sensor_type: MAX31865
# sensor_pin: EBBCan:gpio9
# spi_software_sclk_pin: EBBCan:gpio10
# spi_software_mosi_pin: EBBCan:gpio8
# spi_software_miso_pin: EBBCan:gpio11
# rtd_nominal_r: 100
# rtd_reference_r: 430
# rtd_num_of_wires: 2

[tmc2209 extruder]
uart_pin: EBBCan:gpio20
run_current: 0.5
stealthchop_threshold: 0

## NPN and PNP proximity switch types can be set by jumper
#[probe]
#pin: ^EBBCan:gpio6

#######################
# Config File Helpers #
#######################
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE7, EXP1_2=PG1,
    EXP1_3=PG0, EXP1_4=PF15,
    EXP1_5=PF14, EXP1_6=PF13,    # Slot in the socket on this side
    EXP1_7=PF12, EXP1_8=PF11,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PE15, EXP2_4=PE11,
    EXP2_5=PE10, EXP2_6=PE14,      # Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

# See the sample-lcd.cfg file for definitions of common LCD displays.

############################
# Optional G-Code Features #
############################
[virtual_sdcard]
#   A virtual sdcard may be useful if the host machine is not fast
#   enough to run OctoPrint well. It allows the Klipper host software 
#   to directly print gcode files stored in a directory on the host 
#   using standard sdcard G-Code commands (eg, M24).
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[pause_resume]

[display_status]

[respond]

[exclude_object]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.5565072940913023,
#*# 	1.8926148715931785,
#*# 	0.742976510337138,
#*# 	0.24008145971303738,
#*# 	0.2716292281452262,
#*# 	0.4817677701108122,
#*# 	-0.06033998348467873,
#*# 	-0.4041241593577241,
#*# 	0.09084464025268403,
#*# 	0.19321389816565288
#*# model_domain = 1.8971883995692396e-07,1.9452995227766825e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 22.026797
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.184175, -0.166443, -0.145006, -0.120708, -0.093153, -0.067763, -0.035766, -0.004250, 0.026564, 0.047693, 0.031103, 0.111691, 0.150487, 0.178810, 0.202372, 0.222162, 0.242150, 0.259981, 0.276067, 0.291946
#*# 	-0.177509, -0.155218, -0.136976, -0.114927, -0.089829, -0.060831, -0.032136, -0.002063, 0.026643, 0.056631, 0.086000, 0.114840, 0.144828, 0.173216, 0.196330, 0.218853, 0.236848, 0.253490, 0.268221, 0.283465
#*# 	-0.176065, -0.157372, -0.140656, -0.120543, -0.095525, -0.066104, -0.039223, -0.010689, 0.019950, 0.048211, 0.076115, 0.103862, 0.130858, 0.158601, 0.181084, 0.202584, 0.221267, 0.236327, 0.250618, 0.263810
#*# 	-0.176726, -0.160462, -0.145070, -0.126393, -0.102674, -0.073935, -0.046077, -0.017568, 0.010525, 0.037551, 0.065479, 0.092483, 0.116515, 0.142094, 0.166530, 0.187285, 0.204102, 0.220049, 0.234321, 0.244843
#*# 	-0.174821, -0.163338, -0.149458, -0.130173, -0.108948, -0.082323, -0.053787, -0.024794, 0.003057, 0.030506, 0.056802, 0.081489, 0.104631, 0.129052, 0.152633, 0.171507, 0.188074, 0.203285, 0.216113, 0.227340
#*# 	-0.177629, -0.165824, -0.153466, -0.136151, -0.115416, -0.089767, -0.061239, -0.032866, -0.004679, 0.022898, 0.047973, 0.072720, 0.094999, 0.116050, 0.137696, 0.156539, 0.172910, 0.186508, 0.199440, 0.209297
#*# 	-0.176180, -0.167316, -0.157758, -0.141925, -0.120924, -0.096172, -0.069929, -0.040431, -0.011691, 0.013011, 0.039365, 0.062376, 0.084193, 0.102968, 0.121510, 0.141295, 0.156286, 0.169245, 0.181231, 0.189990
#*# 	-0.175786, -0.167419, -0.159495, -0.144600, -0.125781, -0.102109, -0.075219, -0.047644, -0.019843, 0.006466, 0.031431, 0.055088, 0.074988, 0.092588, 0.109400, 0.125969, 0.139529, 0.152396, 0.163920, 0.171855
#*# 	-0.169606, -0.163268, -0.156733, -0.143110, -0.124019, -0.104262, -0.077855, -0.052452, -0.024183, 0.001869, 0.025962, 0.048307, 0.067910, 0.084666, 0.100355, 0.114041, 0.126450, 0.137496, 0.148187, 0.156124
#*# 	-0.160148, -0.154189, -0.148586, -0.136352, -0.120591, -0.100699, -0.077419, -0.052949, -0.026127, -0.001050, 0.022311, 0.044598, 0.064623, 0.080393, 0.093811, 0.105540, 0.115527, 0.125539, 0.137022, 0.143509
#*# 	-0.148247, -0.143867, -0.138965, -0.127978, -0.113216, -0.095557, -0.074951, -0.051663, -0.027253, -0.001477, 0.021262, 0.041626, 0.060976, 0.076025, 0.088634, 0.099564, 0.107354, 0.115333, 0.124606, 0.132574
#*# 	-0.135424, -0.131474, -0.126897, -0.118379, -0.104359, -0.088878, -0.069751, -0.049768, -0.026791, -0.003900, 0.018763, 0.039543, 0.058030, 0.072473, 0.083874, 0.092806, 0.100809, 0.106142, 0.115283, 0.123791
#*# 	-0.119676, -0.116428, -0.112318, -0.105192, -0.095130, -0.080258, -0.063178, -0.044510, -0.024202, -0.003545, 0.018730, 0.037612, 0.053864, 0.068793, 0.081474, 0.088281, 0.094866, 0.100415, 0.106358, 0.114742
#*# 	-0.104192, -0.099471, -0.097734, -0.092227, -0.082420, -0.068314, -0.053379, -0.038504, -0.020716, -0.001287, 0.017986, 0.037217, 0.053058, 0.066097, 0.077476, 0.084763, 0.090200, 0.095740, 0.099090, 0.105751
#*# 	-0.087702, -0.082959, -0.083215, -0.077639, -0.069043, -0.057404, -0.044655, -0.030618, -0.014609, 0.001678, 0.018669, 0.035811, 0.050860, 0.062350, 0.073570, 0.083175, 0.086960, 0.091644, 0.095655, 0.098966
#*# 	-0.072158, -0.070482, -0.069358, -0.066090, -0.059942, -0.048858, -0.036571, -0.024082, -0.010814, 0.003843, 0.018688, 0.032816, 0.047763, 0.059338, 0.067857, 0.077142, 0.081543, 0.086097, 0.089104, 0.089725
#*# 	-0.056211, -0.057406, -0.058114, -0.056024, -0.050055, -0.041331, -0.030119, -0.018263, -0.006725, 0.004920, 0.017851, 0.030382, 0.043387, 0.054130, 0.063063, 0.070513, 0.076050, 0.078660, 0.080755, 0.081767
#*# 	-0.041303, -0.045802, -0.048430, -0.046905, -0.043853, -0.035426, -0.025412, -0.015099, -0.003743, 0.005448, 0.016120, 0.027107, 0.037572, 0.047922, 0.054999, 0.061306, 0.066501, 0.069848, 0.070466, 0.070728
#*# 	-0.027588, -0.033477, -0.039230, -0.039833, -0.036933, -0.031141, -0.021889, -0.012213, -0.001101, 0.007379, 0.015838, 0.024091, 0.033240, 0.039746, 0.046981, 0.051914, 0.056220, 0.059346, 0.059890, 0.059546
#*# 	-0.015581, -0.023802, -0.031862, -0.034388, -0.032767, -0.028655, -0.020951, -0.010839, -0.001371, 0.006075, 0.013058, 0.020045, 0.026021, 0.032485, 0.037870, 0.040655, 0.042636, 0.045547, 0.045932, 0.044454
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 33.0
#*# max_x = 255.0
#*# min_y = 65.0
#*# max_y = 260.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 23.676
#*# pid_ki = 2.588
#*# pid_kd = 54.157
